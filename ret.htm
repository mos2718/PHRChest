<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>FHIR Chest Discomfort Entry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: sans-serif; line-height: 1.6; max-width: 600px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        select, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #ccc; }
        button { background-color: #28a745; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background-color: #218838; }
        .status { padding: 10px; margin-top: 10px; border-radius: 4px; display: none; }
    </style>
</head>
<body>

    <h2>胸部不適評估 (FHIR Observation)</h2>
    <p>Patient ID: <b>53688389</b></p>

    <label>嚴重程度 (Severity):</label>
    <select id="severity"></select>

    <label>疼痛性質 (Pain Quality):</label>
    <select id="quality"></select>

    <label>擴散部位 (Radiation):</label>
    <select id="radiation"></select>

    <button onclick="uploadToFHIR()">上傳至 FHIR Server</button>

    <div id="status" class="status"></div>

    <script>
        const patientId = "53688389";
        const baseUrl = "https://hapi.fhir.org/baseR4";
        
        const csvLinks = {
            severity: "https://mos2718.github.io/PHRChest/ChestDiscomfortSeverityVS.csv",
            quality: "https://mos2718.github.io/PHRChest/ChestDiscomfortPainQualityVS.csv",
            radiation: "https://mos2718.github.io/PHRChest/ChestDiscomfortRadiationVS.csv"
        };

        // 初始化：讀取所有 CSV 並填充選單
        async function init() {
            for (let key in csvLinks) {
                Papa.parse(csvLinks[key], {
                    download: true,
                    header: true,
                    complete: function(results) {
                        const select = document.getElementById(key);
                        results.data.forEach(row => {
                            if(row.Code) {
                                let opt = document.createElement('option');
                                opt.value = row.Code;
                                opt.text = `${row.Display} (${row.Code})`;
                                opt.dataset.system = row.System;
                                select.appendChild(opt);
                            }
                        });
                    }
                });
            }
        }

        async function uploadToFHIR() {
            const statusDiv = document.getElementById('status');
            
            // 構建 FHIR Observation JSON
            const observation = {
                resourceType: "Observation",
                status: "final",
                category: [{
                    coding: [{ system: "http://terminology.hl7.org/CodeSystem/observation-category", code: "exam", display: "Exam" }]
                }],
                code: {
                    coding: [{ system: "http://loinc.org", code: "10154-3", display: "Chief complaint Chest pain" }]
                },
                subject: { reference: `Patient/${patientId}` },
                effectiveDateTime: new Date().toISOString(),
                component: [
                    getComponent("Severity", "severity"),
                    getComponent("Pain Quality", "quality"),
                    getComponent("Radiation", "radiation")
                ]
            };

            try {
                const response = await fetch(`${baseUrl}/Observation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/fhir+json' },
                    body: JSON.stringify(observation)
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus(`成功！資源 ID: ${result.id}`, "#d4edda", "#155724");
                } else {
                    throw new Error("上傳失敗");
                }
            } catch (error) {
                showStatus(`錯誤: ${error.message}`, "#f8d7da", "#721c24");
            }
        }

        function getComponent(label, elementId) {
            const el = document.getElementById(elementId);
            const selected = el.options[el.selectedIndex];
            return {
                code: { text: label },
                valueCodeableConcept: {
                    coding: [{
                        system: selected.dataset.system,
                        code: el.value,
                        display: selected.text.split(' (')[0]
                    }]
                }
            };
        }

        function showStatus(msg, bg, color) {
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = "block";
            statusDiv.style.backgroundColor = bg;
            statusDiv.style.color = color;
            statusDiv.innerText = msg;
        }

        init();
    </script>
</body>
</html>